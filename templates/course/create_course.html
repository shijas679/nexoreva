{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/course.css' %}">
{% endblock %}

{% block content %}
<div class="main-content">
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h2>
        <i class="bi bi-plus-square"></i>
        Create New Course Structure
      </h2>
    </div>

    <!-- Information Alert -->
    <div class="alert alert-warning" role="alert">
      <strong>Important:</strong> You must create at least one sub-course for each course category. 
      This ensures that when adding courses later, there will always be sub-courses available to select from.
    </div>

    <div class="form-container">
      <form method="POST" id="createCourseForm">
        {% csrf_token %}
        
        <!-- Course Information Section -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="bi bi-book"></i>
            Course Structure Information
          </h3>
          
          <div class="form-grid">
            <div class="input-group full-width">
              <input type="text" id="course_name" name="course_name" required placeholder=" ">
              <label for="course_name">Course Name <span class="text-danger">*</span></label>
              <small class="form-text text-muted">Enter course name (e.g., Engineering, Medical, IT)</small>
            </div>

            <div class="input-group full-width">
              <label class="sub-courses-label">Sub Courses <span class="text-danger">*</span></label>
              <div id="sub_courses_container" class="sub-courses-container">
                <!-- Sub-course input fields will be added here -->
              </div>
              
              <div class="add-sub-course-btn-container">
                <button type="button" id="add_more_btn" class="btn-add-sub-course">
                  <i class="bi bi-plus-circle"></i>
                  Add Sub Course
                </button>
              </div>
              
              <small class="form-text text-muted">
                Add at least one sub-course. Examples: "Computer Science Engineering (CSE)", "MBBS", "Web Development"
              </small>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-submit" id="submitBtn">
            <i class="bi bi-check-circle"></i>
            Create Course Structure
          </button>
          <a href="{% url 'course_list' %}" class="btn-cancel">
            <i class="bi bi-arrow-left"></i>
            Back to Courses
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const addMoreBtn = document.getElementById('add_more_btn');
  const subCoursesContainer = document.getElementById('sub_courses_container');
  const courseNameInput = document.getElementById('course_name');
  const submitBtn = document.getElementById('submitBtn');
  const form = document.getElementById('createCourseForm');

  function createSubCourseInput() {
    const inputBox = document.createElement('div');
    inputBox.className = 'sub-course-input-wrapper';
    inputBox.innerHTML = `
      <div class="sub-course-input-group">
        <input type="text" class="sub-course-input" name="sub_courses[]" placeholder="Enter sub-course name" required>
        <button type="button" class="btn-remove-sub-course" title="Remove sub-course">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    `;

    // Add remove functionality
    const removeBtn = inputBox.querySelector('.btn-remove-sub-course');
    removeBtn.addEventListener('click', function() {
      inputBox.remove();
    });

    return inputBox;
  }

  // Add first sub-course input by default
  const firstInput = createSubCourseInput();
  subCoursesContainer.appendChild(firstInput);

  // Add more sub-course inputs
  addMoreBtn.addEventListener('click', function() {
    const inputBox = createSubCourseInput();
    subCoursesContainer.appendChild(inputBox);
    // Focus on the new input
    inputBox.querySelector('input').focus();
  });

  // Form validation and submission
  form.addEventListener('submit', function(e) {
    const courseName = courseNameInput.value.trim();
    const subCourseInputs = document.querySelectorAll('input[name="sub_courses[]"]');
    let hasValidSubCourse = false;

    if (!courseName) {
      e.preventDefault();
      showNotification('Please enter a course name.', 'warning');
      return;
    }

    subCourseInputs.forEach(input => {
      if (input.value.trim()) {
        hasValidSubCourse = true;
      }
    });

    if (!hasValidSubCourse) {
      e.preventDefault();
      showNotification('Please add at least one sub-course.', 'warning');
      return;
    }

    // Show loading state
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Creating...';
    }
  });
  
  // Notification function
  function showNotification(message, type) {
    // Remove any existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
      <span>${message}</span>
      <button class="notification-close" onclick="this.parentElement.remove()">
        <i class="bi bi-x"></i>
      </button>
    `;
    
    document.querySelector('.form-section').insertBefore(notification, document.querySelector('.form-grid'));
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, 5000);
  }
});
</script>
{% endblock %}
